import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class AppLocalizations {
  final Locale locale;

  AppLocalizations(this.locale);

  static AppLocalizations? of(BuildContext context) {
    return Localizations.of<AppLocalizations>(context, AppLocalizations);
  }

  static const LocalizationsDelegate<AppLocalizations> delegate = _AppLocalizationsDelegate();

  late Map<String, String> _localizedStrings;

  // Hardcoded maps for simplicity given the environment
  static final Map<String, Map<String, String>> _localizedValues = {
    'en': {
      'app_title': 'Health Tracker',
      'hello': 'Hello',
      'guest': 'Guest',
      'home': 'Home',
      'meds': 'Meds',
      'visits': 'Visits',
      'tests': 'Lab Results',
      'measure': 'Measurements',
      'profile': 'Profile',
      'settings': 'Settings',
      'dark_mode': 'Dark Mode',
      'language': 'Language',
      'on': 'On',
      'off': 'Off',
      'edit_profile': 'Edit Profile',
      'save_changes': 'Save Changes',
      'name': 'Name',
      'height': 'Height',
      'weight': 'Weight',
      'gender': 'Gender',
      'cancel': 'Cancel',
      'required': 'Required',
      'today_meds': "Today's Medications",
      'manage': 'Manage',
      'all_caught_up': 'All caught up for today!',
      'taken': 'Taken',
      'bmi': 'BMI',
      'pressure': 'Pressure',
      'sugar': 'Sugar', 
      'add_log': 'Add Log',
      'add_test': 'Add Test',
      'add_visit': 'Add Visit',
      'add_medication': 'Add Medication',
      'full_name': 'Full Name',
      'height_cm': 'Height (cm)',
      'weight_kg': 'Weight (kg)',
      'male': 'Male',
      'female': 'Female',
      'other': 'Other',
      'profile_updated': 'Profile Updated',
      'health_enthusiast': 'Health Enthusiast',
      'my_medications': 'My Medications',
      'no_medications': 'No medications added yet.',
      'delete_medication': 'Delete Medication?',
      'delete_medication_confirm': 'This will permanently remove this medication schedule.',
      'delete': 'Delete',
      'medication_deleted': 'Medication deleted',
      'next_dose_in': 'Next dose in:',
      'prn': 'As Needed (PRN)',
      'my_visits': 'My Visits',
      'search_visit_hint': 'Search doctor or clinic...',
      'no_visits_found': 'No visits found.',
      'no_visits_yet': 'No visits recorded yet.',
      'clear_filters': 'Clear Filters',
      'my_tests': 'My Lab Results',
      'search_test_hint': 'Search by test name...',
      'no_matches_found': 'No matches found.',
      'no_tests_yet': 'No tests recorded yet.',
      'measurements': 'Measurements',
      'no_data_for': 'No data for',
      'add_log': 'Add Log',
      'edit_measurement': 'Edit Measurement',
      'add_measurement': 'Add Measurement',
      'type': 'Type',
      'value': 'Value',
      'systolic': 'Systolic',
      'diastolic': 'Diastolic',
      'date': 'Date',
      'note_optional': 'Note (Optional)',
      'save': 'Save',
      'updated': 'Updated',
      'saved': 'Saved',
      'error': 'Error',
      'delete_confirm_title': 'Delete?',
      'delete_measurement_confirm': 'Delete this measurement?',
      'yes': 'Yes',
      'no': 'No',
      'invalid': 'Invalid',
      'edit_medication': 'Edit Medication',
      'add_medication': 'Add Medication',
      'quick_add': 'Quick Add',
      'advanced': 'Advanced',
      'medication_name': 'Medication Name',
      'dosage_optional': 'Dosage (Optional)',
      'dosage_hint': 'e.g. 500mg',
      'start_date': 'Start Date',
      'duration': 'Duration',
      'ongoing': 'Ongoing',
      'duration_days': 'Duration (Days)',
      'duration_hint': 'e.g. 7',
      'update_medication': 'Update Medication',
      'save_medication': 'Save Medication',
      'frequency': 'Frequency',
      'as_needed': 'As Needed',
      'first_dose_time': 'First Dose Time',
      'reminder_daily': 'Reminder at this time daily.',
      'reminder_2x': 'Reminders at this time and 12 hours later.',
      'reminder_3x': 'Reminders at this time, +8h, and +16h.',
      'dose_times': 'Dose Times',
      'instructions_optional': 'Instructions (Optional)',
      'instruction_none': 'None',
      'instruction_before_food': 'Before Food',
      'instruction_after_food': 'After Food',
      'todays_medications': "Today's Medications",
      'manage': 'Manage',
      'all_caught_up': 'All caught up for today!',
      'taken': 'Taken',
      'marked_as_taken': 'marked as taken',
      'weight': 'Weight',
      'bmi': 'BMI',
      'pressure': 'Pressure',
      'sugar': 'Sugar',
      'visit_details': 'Visit Details',
      'delete_visit': 'Delete Visit?',
      'delete_record': 'Delete Record?',
      'cannot_be_undone': 'This cannot be undone.',
      'clinic_hospital': 'Clinic / Hospital',
      'notes': 'Notes',
      'no_notes': 'No notes recorded',
      'attachment': 'Attachment',
      'file_attachment': 'File attachment',
      'test_details': 'Test Details',
      'result': 'Result',
      'not_recorded': 'Not recorded',
      'view_attachment': 'View Attachment',
      'tap_to_open': 'Tap to open file',
      'could_not_open': 'Could not open attachment',
      'edit_visit': 'Edit Visit',
      'add_visit': 'Add Visit',
      'save_visit': 'Save Visit',
      'doctor_name': 'Doctor Name *',
      'specialty_hint': 'Specialty (e.g. Cardiology)',
      'clinic_hint': 'Clinic / Hospital Name',
      'visit_date': 'Date of Visit *',
      'attach_file': 'Attach Prescription / Report',
      'edit_test': 'Edit Test',
      'add_test_result': 'Add Test Result',
      'update_record': 'Update Record',
      'save_record': 'Save Record',
      'test_name_required': 'Test Name (Required)',
      'test_name_error': 'Please enter test name',
      'test_date': 'Test Date',
      'result_optional': 'Result (Optional)',
      'change_attachment': 'Change Attachment',
      'attach_pdf_image': 'Attach File (PDF/Image)',
      'selected': 'Selected',
      'pulse': 'Pulse',
      'temperature': 'Temperature',
      'logout': 'Log Out',
      'logout_confirm': 'Are you sure you want to log out?',
      'nav_tests': 'Labs',
      'nav_measure': 'Vitals',
      'login_required': 'Login Required',
      'login_required_msg': 'You need to sign in to perform this action.',
      'continue_google': 'Continue with Google',
      'continue_email': 'Continue with Email',
      'continue_guest': 'Continue as Guest',
      'or_divider': 'OR',
      'email_hint': 'Enter your email',
      'password_hint': 'Enter your password',
      'login': 'Login',
      'register': 'Register',
      'dont_have_account': 'Don\'t have an account?',
      'sign_up': 'Sign Up',
      'already_have_account': 'Already have an account?',
      'sign_in': 'Sign In',
      'complete_profile': 'Complete Your Profile',
      'profile_description': 'Please provide some basic info to get started.',
      'save_continue': 'Save & Continue',
      'height_optional': 'Height (cm) - Optional',
      'weight_optional': 'Weight (kg) - Optional',
      'gender_optional': 'Gender - Optional',
      'enter_name_error': 'Please enter your name',
      'invalid_height': 'Invalid height',
      'invalid_weight': 'Invalid weight',
      'email_label': 'Email',
      'password_label': 'Password',
      'auth_google': 'Google',
      'auth_guest': 'Guest',
      'create_account': 'Create Account',
      'min_password_len': 'Min 6 chars',
      'invalid_email': 'Invalid Email',
      'swipe_to_take_hint': 'Tip: Swipe right to mark as taken!',
    },
    'ar': {
      'app_title': 'متتبع الصحة',
      'hello': 'مرحباً',
      'guest': 'زائر',
      'home': 'الرئيسية',
      'meds': 'أدوية',
      'visits': 'زيارات',
      'tests': 'تحاليل',
      'measure': 'قياسات',
      'profile': 'الملف الشخصي',
      'settings': 'الإعدادات',
      'dark_mode': 'الوضع الليلي',
      'language': 'اللغة',
      'on': 'مفعل',
      'off': 'معطل',
      'edit_profile': 'تعديل الملف',
      'save_changes': 'حفظ التغييرات',
      'name': 'الاسم',
      'height': 'الطول',
      'weight': 'الوزن',
      'gender': 'الجنس',
      'cancel': 'إلغاء',
      'required': 'مطلوب',
      'today_meds': 'أدوية اليوم',
      'manage': 'إدارة',
      'all_caught_up': 'أتممت كل شيء لليوم!',
      'taken': 'تم أخذها',
      'bmi': 'كتلة الجسم',
      'pressure': 'الضغط',
      'sugar': 'السكر',
      'add_log': 'إضافة سجل',
      'add_test': 'إضافة تحليل',
      'add_visit': 'إضافة زيارة',
      'add_medication': 'إضافة دواء',
      'full_name': 'الاسم الكامل',
      'height_cm': 'الطول (سم)',
      'weight_kg': 'الوزن (كجم)',
      'male': 'ذكر',
      'female': 'أنثى',
      'other': 'آخر',
      'profile_updated': 'تم تحديث الملف الشخصي',
      'health_enthusiast': 'مهتم بالصحة',
      'my_medications': 'أدويتي',
      'no_medications': 'لم تتم إضافة أدوية بعد.',
      'delete_medication': 'حذف الدواء؟',
      'delete_medication_confirm': 'سيؤدي هذا إلى حذف جدول الدواء نهائياً.',
      'delete': 'حذف',
      'medication_deleted': 'تم حذف الدواء',
      'next_dose_in': 'الجرعة القادمة خلال:',
      'prn': 'عند الحاجة',
      'my_visits': 'زياراتي',
      'search_visit_hint': 'ابحث عن طبيب أو عيادة...',
      'no_visits_found': 'لم يتم العثور على زيارات.',
      'no_visits_yet': 'لم يتم تسجيل زيارات بعد.',
      'clear_filters': 'مسح التصفية',
      'my_tests': 'نتائج التحاليل',
      'search_test_hint': 'ابحث باسم التحليل...',
      'no_matches_found': 'لم يتم العثور على نتائج.',
      'no_tests_yet': 'لم يتم تسجيل تحاليل بعد.',
      'measurements': 'القياسات',
      'no_data_for': 'لا توجد بيانات لـ',
      'add_log': 'إضافة سجل',
      'edit_measurement': 'تعديل القياس',
      'add_measurement': 'إضافة قياس',
      'type': 'النوع',
      'value': 'القيمة',
      'systolic': 'الانقباضي',
      'diastolic': 'الانبساطي',
      'date': 'التاريخ',
      'note_optional': 'ملاحظة (اختياري)',
      'save': 'حفظ',
      'updated': 'تم التحديث',
      'saved': 'تم الحفظ',
      'error': 'خطأ',
      'delete_confirm_title': 'حذف؟',
      'delete_measurement_confirm': 'هل أنت متأكد من حذف هذا القياس؟',
      'yes': 'نعم',
      'no': 'لا',
      'invalid': 'غير صالح',
      'edit_medication': 'تعديل الدواء',
      'add_medication': 'إضافة دواء',
      'quick_add': 'إضافة سريعة',
      'advanced': 'متقدم',
      'medication_name': 'اسم الدواء',
      'dosage_optional': 'الجرعة (اختياري)',
      'dosage_hint': 'مثال: 500ملغ',
      'start_date': 'تاريخ البدء',
      'duration': 'المدة',
      'ongoing': 'مستمر',
      'duration_days': 'المدة (بالأيام)',
      'duration_hint': 'مثال: 7',
      'update_medication': 'تحديث الدواء',
      'save_medication': 'حفظ الدواء',
      'frequency': 'التكرار',
      'as_needed': 'عند الحاجة',
      'first_dose_time': 'وقت الجرعة الأولى',
      'reminder_daily': 'تذكير في هذا الوقت يومياً.',
      'reminder_2x': 'تذكير في هذا الوقت وبعد 12 ساعة.',
      'reminder_3x': 'تذكير في هذا الوقت، +8 ساعات، و +16 ساعة.',
      'dose_times': 'أوقات الجرعات',
      'instructions_optional': 'تعليمات (اختياري)',
      'instruction_none': 'بلا',
      'instruction_before_food': 'قبل الأكل',
      'instruction_after_food': 'بعد الأكل',
      'todays_medications': "أدوية اليوم",
      'manage': 'إدارة',
      'all_caught_up': 'لقد أكملت كل شيء لليوم!',
      'taken': 'تم أخذها',
      'marked_as_taken': 'تم تحديدها كمأخوذة',
      'weight': 'الوزن',
      'bmi': 'مؤشر الكتلة',
      'pressure': 'الضغط',
      'sugar': 'السكر',
      'visit_details': 'تفاصيل الزيارة',
      'delete_visit': 'حذف الزيارة؟',
      'delete_record': 'حذف السجل؟',
      'cannot_be_undone': 'لا يمكن التراجع عن هذا الإجراء.',
      'clinic_hospital': 'العيادة / المستشفى',
      'notes': 'ملاحظات',
      'no_notes': 'لا توجد ملاحظات',
      'attachment': 'مرفق',
      'file_attachment': 'ملف مرفق',
      'test_details': 'تفاصيل التحليل',
      'result': 'النتيجة',
      'not_recorded': 'غير مسجل',
      'view_attachment': 'عرض المرفق',
      'tap_to_open': 'اضغط لفتح الملف',
      'could_not_open': 'تعذر فتح المرفق',
      'edit_visit': 'تعديل الزيارة',
      'add_visit': 'إضافة زيارة',
      'save_visit': 'حفظ الزيارة',
      'doctor_name': 'اسم الطبيب *',
      'specialty_hint': 'التخصص (مثل: قلبية)',
      'clinic_hint': 'اسم العيادة / المستشفى',
      'visit_date': 'تاريخ الزيارة *',
      'attach_file': 'إرفاق وصفة / تقرير',
      'edit_test': 'تعديل التحليل',
      'add_test_result': 'إضافة نتيجة تحليل',
      'update_record': 'تحديث السجل',
      'save_record': 'حفظ السجل',
      'test_name_required': 'اسم التحليل (مطلوب)',
      'test_name_error': 'يرجى إدخال اسم التحليل',
      'test_date': 'تاريخ التحليل',
      'result_optional': 'النتيجة (اختياري)',
      'change_attachment': 'تغيير المرفق',
      'attach_pdf_image': 'إرفاق ملف (PDF/صورة)',
      'selected': 'تم تحديد',
      'pulse': 'نبض',
      'temperature': 'درجة الحرارة',
      'logout': 'تسجيل الخروج',
      'logout_confirm': 'هل أنت متأكد من تسجيل الخروج؟',
      'nav_tests': 'تحاليل',
      'nav_measure': 'قياسات',
      'login_required': 'تسجيل الدخول مطلوب',
      'login_required_msg': 'يجب عليك تسجيل الدخول للقيام بهذا الإجراء.',
      'continue_google': 'المتابعة باستخدام Google',
      'continue_email': 'المتابعة باستخدام البريد',
      'continue_guest': 'المتابعة كزائر',
      'or_divider': 'أو',
      'email_hint': 'أدخل بريدك الإلكتروني',
      'password_hint': 'أدخل كلمة المرور',
      'login': 'دخول',
      'register': 'تسجيل',
      'dont_have_account': 'ليس لديك حساب؟',
      'sign_up': 'سجل الآن',
      'already_have_account': 'لديك حساب بالفعل؟',
      'sign_in': 'تسجيل الدخول',
      'complete_profile': 'إكمال ملفك الشخصي',
      'profile_description': 'يرجى تقديم بعض المعلومات الأساسية للبدء.',
      'save_continue': 'حفظ ومتابعة',
      'height_optional': 'الطول (سم) - اختياري',
      'weight_optional': 'الوزن (كجم) - اختياري',
      'gender_optional': 'الجنس - اختياري',
      'enter_name_error': 'يرجى إدخال اسمك',
      'invalid_height': 'طول غير صالح',
      'invalid_weight': 'وزن غير صالح',
      'email_label': 'البريد الإلكتروني',
      'password_label': 'كلمة المرور',
      'auth_google': 'جوجل',
      'auth_guest': 'زائر',
      'create_account': 'إنشاء حساب',
      'min_password_len': '6 أحرف على الأقل',
      'invalid_email': 'بريد غير صالح',
      'swipe_to_take_hint': 'تلميح: اسحب لليمين لتحديد كـ مأخوذ!',
    },
  };

  Future<bool> load() async {
    // In a bigger app, we would load from JSON files assets/lang/{languageCode}.json
    // Here we use the static map for immediate speed and reliability
    _localizedStrings = _localizedValues[locale.languageCode] ?? _localizedValues['en']!;
    return true;
  }

  String translate(String key) {
    return _localizedStrings[key] ?? key;
  }
}

class _AppLocalizationsDelegate extends LocalizationsDelegate<AppLocalizations> {
  const _AppLocalizationsDelegate();

  @override
  bool isSupported(Locale locale) {
    return ['en', 'ar'].contains(locale.languageCode);
  }

  @override
  Future<AppLocalizations> load(Locale locale) async {
    AppLocalizations localizations = AppLocalizations(locale);
    await localizations.load();
    return localizations;
  }

  @override
  bool shouldReload(_AppLocalizationsDelegate old) => false;
}
